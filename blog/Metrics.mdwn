# Background

I'm too embarrassed to write this "statistics architecture" up on the
[Webconverger blog](http://r2d2.webconverger.org/2013-01-19/gnuplot-zoom.html)
and this is too technical for [Natalian](http://natalian.org/).

After messing around with [Anselm's monitor rc
scripts](https://github.com/kaihendry/monitor), [fiddling with
GNUplot](https://github.com/kaihendry/laptemp), looking into
[statsd](https://github.com/etsy/statsd) and
[graphite](https://launchpad.net/graphite) (v. scary) and watching [metrics
everywhere](http://pivotallabs.com/139-metrics-metrics-everywhere/)... I have a LOT to think about.

Of course I want to apply the [suckless
philosophy](http://suckless.org/philosophy) and cut through the crap.

# Measure what?

I started with this faux problem of measuring my machine temperature, since
this is related to Webconverger deployments, that require monitoring.
Monitoring translates to business value, since this is what clients are
prepared to pay for.

My "suckless" approach is to generate time series CSV rooted on epoch time.

	*/5 * * * * echo $(date +%s) $(cat /proc/temp) | ssh server 'cat - >> /data/${id:-$SSH_CLIENT}/temp/$(date +%j).csv'

Over a ssh socket. Then on the server we either run GNUplot over the CSV or
[churn it in JSON](https://github.com/Webconverger/dl/blob/master/toJSON.sh)
and write put the data into a [time series
graph](http://dl.webconverger.com/stats/).

The problem with quirky GNUplot is that the Web output of a PNG or SVG can be
[difficult to
explore](http://r2d2.webconverger.org/2013-01-19/gnuplot-zoom.html) or interact
with. However it's powerful, fast and plays well with shell.

Then again the JSON frontend is easier to write and interact with, but it can
become pretty darn cumbersome.

The CSV files can be probably managed with `logrotate`.

This approach makes a number of assumptions about ssh and the frequency and
such and so forth. And it lacks monitoring **alerts**. I'm not quite sure how
to do that yet. Perhaps extra logic on the server, that filters new data and if
something goes wrong, it sends an alert. My preference would probably be an
email.

# What else should I be measuring?

Important elements for Webconverger are number of subscriptions. Of course this
could be a @daily (instead of every 5 minutes) thing:

	1358518011 45
	1358604429 44

So our generic time series "grapher" script can easily draw this, to show 45
subscribers yesterday and 44 today.

What about something more complicated like, [ping.csv](http://ping.webconverger.org/):

	epoch IP VERSION COUNTRY ID
	1358604429 206.78.148.37 16.0 US ae653a33b312fa3943541f8ac9c9b781

We need to tweak the script that counts things up for a day and then generates
another CSV that filters in a different GNUplot graphing script to generate a
graph.

So on the server we can have we have at its simplest:

	$WWWROOT/$machineid/$graphname/$(date +%j).csv -> $WWWROOT/$machineid/$graphname.sh -> /srv/www/example.com/stats/$machineid/$graphname.png

`$WWWROOT/*/*/*.csv` is managed by logrotate.

Now with a different "graph script", generic-json.js:

	ln -s generic-json.sh $WWWROOT/$machineid/$graphname.sh

	$WWWROOT/$machineid/$graphname/$(date +%j).csv -> $WWWROOT/$machineid/$graphname.sh -> /srv/www/example.com/stats/$machineid/$graphname.json -> /srv/www/example.com/stats/$machineid/$graphname/index.{js,css,html}

html/js example: <http://dl.webconverger.com/stats/>

Perhaps we need some filtering / tweaking?

	ln -s special-gnuplot.sh $WWWROOT/$machineid/$graphname.sh

	$WWWROOT/$machineid/$graphname/$(date +%j).csv -> $WWWROOT/$machineid/$graphname.sh -> /srv/www/example.com/stats/$machineid/$graphname.png

The frequency of how often this generate (i.e. call $graphname.sh) can be
triggered by `inotifywait` on the server. i.e. when it sees new data, it calls
the graphing script.

## Client Hierarchy

	*/10 * * * * echo $(date +%s) $(cat /proc/temp) | ssh $server 'cat - >> $WWWROOT/$machineid/$graphname/$(date +%j).csv'

## Server Hierarchy

	$SCRIPTROOT
	$WWWROOT

Client appends to server's $WWWROOT/$machineid/$graphname/$(date +%j).csv

* WWWROOT = /srv/www/stats.example.com
* machineid = $UUID;$mac, /etc/machine-id, or even $SSH_CLIENT
* graphname = temp

	while true
	do
		inotifywait -m -e append "$(date +%j).csv"
		for i in *.sh; ./$i; done
	done

Example scripts in $SCRIPTROOT

You are encouraged to create your own scripts, based upon $SCRIPTROOT/{prune,json,png}.sh

Generates just the PNG file using GNUplot:

	ln -s $SCRIPTROOT/png.sh $WWWROOT/$machineid/$graphname/
	Output: $WWWROOT/$machineid/$graphname.png

`png.sh` by default can take the last 30 days, `ls -t *.csv | tail -n30`

Generates just the json output files:

	ln -s $SCRIPTROOT/json.sh $WWWROOT/$machineid/$graphname/
	Output: $WWWROOT/$machineid/$graphname.json
