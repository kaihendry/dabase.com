name: Test podcast sync

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq ripgrep
          sudo curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
          sudo chmod a+rx /usr/local/bin/yt-dlp

      - name: Count episodes on published site
        id: published
        run: |
          RSS_COUNT=$(curl -s https://dabase.com/podcast/index.xml | rg -c "<item>")
          echo "count=$RSS_COUNT" >> $GITHUB_OUTPUT
          echo "Published RSS episode count: $RSS_COUNT"

      - name: Count available episodes in YouTube playlist
        id: youtube
        run: |
          PLAYLIST_URL="https://www.youtube.com/playlist?list=PLiKgVPlhUNuyTXzN03gCB1lqvaHXxPLak"
          # Count only available videos (yt-dlp skips unavailable ones)
          # Exclude re-upload video ID: UXIJe2moZ-I
          YT_COUNT=$(yt-dlp --flat-playlist --print "%(id)s" "$PLAYLIST_URL" 2>&1 | rg -v "unavailable" | rg "^[a-zA-Z0-9_-]{11}$" | rg -v "UXIJe2moZ-I" | wc -l)
          echo "count=$YT_COUNT" >> $GITHUB_OUTPUT
          echo "YouTube available episode count: $YT_COUNT"

      - name: Validate episode counts match
        run: |
          PUBLISHED_COUNT=${{ steps.published.outputs.count }}
          YT_COUNT=${{ steps.youtube.outputs.count }}
          echo "Published episodes: $PUBLISHED_COUNT"
          echo "YouTube episodes: $YT_COUNT"
          if [ "$PUBLISHED_COUNT" != "$YT_COUNT" ]; then
            echo "::warning::Episode count mismatch! Published has $PUBLISHED_COUNT, YouTube has $YT_COUNT"
            echo "This may be expected if a deploy is in progress"
          else
            echo "Episode counts match!"
          fi

      - name: Validate RSS feed structure
        run: |
          echo "Checking RSS feed structure..."
          curl -s https://dabase.com/podcast/index.xml > /tmp/rss.xml

          # Check for required iTunes tags
          if ! rg -q "<itunes:author>" /tmp/rss.xml; then
            echo "::error::Missing itunes:author tag"
            exit 1
          fi

          if ! rg -q "<itunes:image" /tmp/rss.xml; then
            echo "::error::Missing itunes:image tag"
            exit 1
          fi

          echo "RSS feed structure is valid!"

      - name: Check all audio URLs exist
        run: |
          echo "Checking all audio URLs from RSS feed..."
          URLS=$(rg -o 'url="https://dabase\.com[^"]+\.mp3' /tmp/rss.xml | sed 's/url="//')

          if [ -z "$URLS" ]; then
            echo "::error::No audio URLs found in RSS feed!"
            exit 1
          fi

          TOTAL=$(echo "$URLS" | wc -l)
          echo "Found $TOTAL audio files to verify"

          for url in $URLS; do
            echo "Checking: $url"
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --head "$url")
            if [ "$HTTP_CODE" != "200" ]; then
              echo "::error::Missing audio file (HTTP $HTTP_CODE): $url"
              exit 1
            else
              echo "OK: $url"
            fi
          done
          echo "All $TOTAL audio URLs verified!"
