name: Test podcast sync

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          sudo curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
          sudo chmod a+rx /usr/local/bin/yt-dlp

      - name: Build Hugo site
        run: hugo

      - name: Count episodes in episodes.json
        id: hugo
        run: |
          HUGO_COUNT=$(jq 'length' content/podcast/metadata/episodes.json)
          echo "count=$HUGO_COUNT" >> $GITHUB_OUTPUT
          echo "Episodes in episodes.json: $HUGO_COUNT"

      - name: Count episodes in YouTube playlist
        id: youtube
        run: |
          PLAYLIST_URL="https://www.youtube.com/playlist?list=PLiKgVPlhUNuyTXzN03gCB1lqvaHXxPLak"
          YT_COUNT=$(yt-dlp --flat-playlist --print "%(id)s" "$PLAYLIST_URL" 2>/dev/null | wc -l | tr -d ' ')
          echo "count=$YT_COUNT" >> $GITHUB_OUTPUT
          echo "YouTube episode count: $YT_COUNT"

      - name: Validate episode counts match
        run: |
          HUGO_COUNT=${{ steps.hugo.outputs.count }}
          YT_COUNT=${{ steps.youtube.outputs.count }}
          echo "Hugo episodes: $HUGO_COUNT"
          echo "YouTube episodes: $YT_COUNT"
          if [ "$HUGO_COUNT" != "$YT_COUNT" ]; then
            echo "::error::Episode count mismatch! Hugo has $HUGO_COUNT, YouTube has $YT_COUNT"
            exit 1
          fi
          echo "Episode counts match!"

      - name: Validate podcast description
        run: |
          # Note: & becomes &amp; in HTML
          if grep -q 'content="A podcast about Infrastructure .* AI engineering techniques"' public/podcast/index.html; then
            echo "Description is correct!"
          else
            echo "::error::Description not found in podcast page"
            grep -A1 'name="description"' public/podcast/index.html
            exit 1
          fi

      - name: Validate RSS feed
        run: |
          # Check RSS has episodes (built from committed markdown files)
          RSS_COUNT=$(grep -c "<item>" public/podcast/index.xml)
          MD_COUNT=$(find content/podcast -maxdepth 1 -name "*.md" ! -name "_index.md" | wc -l | tr -d ' ')
          echo "RSS episode count: $RSS_COUNT"
          echo "Markdown files: $MD_COUNT"
          if [ "$RSS_COUNT" != "$MD_COUNT" ]; then
            echo "::error::RSS count mismatch! RSS has $RSS_COUNT, markdown has $MD_COUNT"
            exit 1
          fi
          echo "RSS feed matches markdown files!"

      - name: Check podcast audio URLs exist
        run: |
          echo "Checking audio URLs in RSS feed..."
          MISSING=0
          for url in $(grep -oP 'url="https://dabase\.com/podcast/audio/[^"]+' public/podcast/index.xml | sed 's/url="//'); do
            # Check URL returns 200 with HEAD request
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --head "$url")
            if [ "$HTTP_CODE" != "200" ]; then
              echo "::error::Missing audio file (HTTP $HTTP_CODE): $url"
              MISSING=$((MISSING + 1))
            else
              echo "OK: $url"
            fi
          done
          if [ "$MISSING" -gt 0 ]; then
            echo "::error::$MISSING audio files missing"
            exit 1
          fi
          echo "All audio URLs verified!"
